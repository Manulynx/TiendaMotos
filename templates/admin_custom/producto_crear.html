{% extends 'admin_custom/base.html' %} 
{% block title %}Crear Producto{%endblock%} 
{% block page_title %}Crear Nuevo Producto{% endblock %} 
{%block page_subtitle %}Agregar al inventario {% endblock %} 
{% block content %}

<form
  id="producto-form"
  class="max-w-4xl mx-auto"
  enctype="multipart/form-data"
>
  {% csrf_token %}

  <div class="bg-white rounded-xl shadow-sm p-4 md:p-8 border border-gray-100">
    <div class="space-y-4 md:space-y-6">
      <!-- Nombre -->
      <div>
        <label class="block text-xs md:text-sm font-medium text-gray-700 mb-2">
          Nombre del Producto *
        </label>
        <input
          type="text"
          name="nombre"
          required
          class="w-full px-3 md:px-4 py-2.5 md:py-3 text-sm md:text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-accent focus:border-transparent transition-all"
          placeholder="Ej: Honda CBR 600RR"
        />
      </div>

      <!-- Categor칤a y Precio -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
        <div>
          <label
            class="block text-xs md:text-sm font-medium text-gray-700 mb-2"
          >
            Categor칤a *
          </label>
          <select
            name="categoria"
            required
            class="w-full px-3 md:px-4 py-2.5 md:py-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-accent focus:border-transparent transition-all"
          >
            <option value="">Seleccionar...</option>
            {% for cat in categorias %}
            <option value="{{ cat.id }}">{{ cat.nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="grid grid-cols-3 gap-2 md:gap-3">
          <div class="col-span-2">
            <label
              class="block text-xs md:text-sm font-medium text-gray-700 mb-2"
            >
              Precio *
            </label>
            <input
              type="number"
              step="0.01"
              name="precio"
              required
              class="w-full px-3 md:px-4 py-2.5 md:py-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-accent focus:border-transparent transition-all"
              placeholder="0.00"
            />
          </div>

          <div>
            <label
              class="block text-xs md:text-sm font-medium text-gray-700 mb-2"
            >
              Moneda
            </label>
            <select
              name="moneda"
              class="w-full px-2 md:px-4 py-2.5 md:py-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-accent focus:border-transparent transition-all"
            >
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="CUP">CUP</option>
              <option value="MLC">MLC</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Stock -->
      <div>
        <label class="block text-xs md:text-sm font-medium text-gray-700 mb-2">
          Stock Inicial
        </label>
        <input
          type="number"
          name="stock"
          value="0"
          min="0"
          class="w-full px-3 md:px-4 py-2.5 md:py-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-accent focus:border-transparent transition-all"
        />
      </div>

      <!-- Colores Disponibles -->
      <div>
        <label class="block text-xs md:text-sm font-medium text-gray-700 mb-3">
          Colores Disponibles
        </label>
        <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-3">
          {% for color in colores %}
          <label
            class="cursor-pointer group relative"
            title="{{ color.nombre }}"
          >
            <input
              type="checkbox"
              name="colores"
              value="{{ color.id }}"
              class="sr-only peer"
            />
            <div
              class="w-12 h-12 rounded-full border-2 border-gray-300 peer-checked:border-blue-dark peer-checked:ring-2 peer-checked:ring-blue-dark peer-checked:ring-offset-2 transition-all hover:scale-110 relative overflow-hidden"
              style="background-color: {{ color.codigo_hex }};"
            >
              <!-- Checkmark cuando est치 seleccionado -->
              <svg
                class="absolute inset-0 m-auto w-6 h-6 text-white opacity-0 peer-checked:opacity-100 transition-opacity"
                style="filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5))"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="3"
                  d="M5 13l4 4L19 7"
                />
              </svg>
            </div>
            <!-- Tooltip con nombre del color -->
            <span
              class="absolute -bottom-6 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-10"
            >
              {{ color.nombre }}
            </span>
          </label>
          {% endfor %}
        </div>
        <p class="mt-2 text-xs text-gray-500">
          游눠 Selecciona todos los colores en los que est치 disponible este
          producto.
        </p>
      </div>

      <!-- Descripci칩n -->
      <div>
        <label class="block text-xs md:text-sm font-medium text-gray-700 mb-2">
          Descripci칩n
        </label>
        <textarea
          name="descripcion"
          rows="5"
          class="w-full px-3 md:px-4 py-2.5 md:py-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-accent focus:border-transparent transition-all"
          placeholder="Describe las caracter칤sticas del producto..."
        ></textarea>
      </div>

      <!-- Atributos Din치micos -->
      <div>
        <div class="flex items-center justify-between mb-3">
          <label class="block text-xs md:text-sm font-medium text-gray-700">
            Especificaciones T칠cnicas
            <span
              id="tipo-categoria-label"
              class="text-xs text-purple-600 ml-2"
            ></span>
          </label>
          <a
            href="{% url 'productos:admin_atributos_lista' %}"
            target="_blank"
            class="text-xs text-blue-600 hover:text-blue-700 font-medium"
          >
            + Gestionar atributos
          </a>
        </div>

        <div id="atributos-container" class="space-y-3">
          <p class="text-gray-500 text-sm text-center py-6">
            Selecciona una categor칤a para ver los atributos disponibles
          </p>
        </div>

        <p class="mt-2 text-xs text-gray-500">
          游눠 Los atributos se cargan autom치ticamente seg칰n la categor칤a
          seleccionada.
        </p>
      </div>

      <!-- Imagen -->
      <div>
        <label class="block text-xs md:text-sm font-medium text-gray-700 mb-3">
          Imagen Principal
        </label>
        <div
          class="border-2 border-dashed border-gray-300 rounded-xl p-6 md:p-8 text-center hover:border-red-accent transition-colors cursor-pointer"
          onclick="document.getElementById('imagen-input').click()"
        >
          <div id="preview-container">
            <svg
              class="w-12 h-12 md:w-16 md:h-16 mx-auto mb-2 md:mb-3 text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
              />
            </svg>
            <p class="text-sm md:text-base text-gray-600 font-medium mb-1">
              Click para subir imagen
            </p>
            <p class="text-xs md:text-sm text-gray-400">PNG, JPG hasta 5MB</p>
          </div>
        </div>
        <input
          type="file"
          id="imagen-input"
          name="imagen"
          accept="image/*"
          class="hidden"
          onchange="previewImagen(event)"
        />
      </div>

      <!-- Galer칤a de Im치genes -->
      <div>
        <label class="block text-xs md:text-sm font-medium text-gray-700 mb-3">
          Galer칤a de Im치genes (Opcional)
        </label>
        <div
          class="border-2 border-dashed border-gray-300 rounded-xl p-6 md:p-8 text-center hover:border-purple-500 transition-colors cursor-pointer"
          onclick="document.getElementById('galeria-input').click()"
        >
          <div id="galeria-preview-container">
            <svg
              class="w-12 h-12 md:w-16 md:h-16 mx-auto mb-2 md:mb-3 text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
              />
            </svg>
            <p class="text-sm md:text-base text-gray-600 font-medium mb-1">
              Click para subir m칰ltiples im치genes
            </p>
            <p class="text-xs md:text-sm text-gray-400">
              Puedes seleccionar varias im치genes a la vez
            </p>
          </div>
        </div>
        <input
          type="file"
          id="galeria-input"
          name="galeria"
          accept="image/*"
          multiple
          class="hidden"
          onchange="previewGaleria(event)"
        />

        <!-- Grid de previsualizaciones -->
        <div
          id="galeria-grid"
          class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 mt-4 hidden"
        ></div>

        <p class="mt-2 text-xs text-gray-500">
          游눠 Puedes seleccionar m칰ltiples im치genes para la galer칤a del producto.
        </p>
      </div>
    </div>
  </div>

  <!-- Botones de Acci칩n -->
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-30 md:left-64">
    <div class="max-w-6xl mx-auto px-4 py-3">
      <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
        <button
          type="submit"
          id="submit-btn"
          class="flex-1 px-6 py-2.5 text-sm bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-all font-semibold flex items-center justify-center gap-2 shadow-sm"
        >
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"
            />
          </svg>
          Crear Producto
        </button>

        <a
          href="{% url 'productos:admin_productos_lista' %}"
          class="px-6 py-2.5 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all font-semibold text-center flex items-center justify-center gap-2"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
          Cancelar
        </a>
      </div>
    </div>
  </div>

</form>

{% endblock %} {% block extra_js %}
<script>
  // Preview de imagen principal
  function previewImagen(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const container = document.getElementById("preview-container");
        container.innerHTML = `
          <div class="relative">
            <img src="${e.target.result}" class="max-w-full h-48 mx-auto rounded-lg object-cover shadow-sm">
            <button type="button" onclick="clearImagen()" class="absolute top-2 right-2 p-1.5 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <p class="text-xs text-gray-600 mt-2 truncate">${file.name}</p>
        `;
      };
      reader.readAsDataURL(file);
    }
  }

  function clearImagen() {
    document.getElementById("imagen-input").value = "";
    const container = document.getElementById("preview-container");
    container.innerHTML = `
      <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
      </svg>
      <p class="text-sm text-gray-600 font-medium mb-1">Click para subir imagen</p>
      <p class="text-xs text-gray-400">PNG, JPG hasta 5MB</p>
    `;
  }

  // Preview de galer칤a de im치genes
  let galeriaFiles = [];

  function previewGaleria(event) {
    const files = Array.from(event.target.files);
    galeriaFiles = files;

    const grid = document.getElementById("galeria-grid");
    const previewContainer = document.getElementById("galeria-preview-container");

    if (files.length === 0) {
      grid.classList.add("hidden");
      previewContainer.innerHTML = `
        <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        <p class="text-sm text-gray-600 font-medium mb-1">Click para m칰ltiples im치genes</p>
        <p class="text-xs text-gray-400">Selecciona varias im치genes a la vez</p>
      `;
      return;
    }

    grid.classList.remove("hidden");
    grid.innerHTML = "";

    files.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = function (e) {
        const div = document.createElement("div");
        div.className = "relative group";
        div.innerHTML = `
          <img src="${e.target.result}" 
               alt="${file.name}" 
               class="w-full h-20 object-cover rounded-lg border border-gray-200">
          <button type="button" 
                  onclick="eliminarImagenGaleria(${index})"
                  class="absolute top-1 right-1 p-1 bg-red-500 text-white rounded-lg opacity-0 group-hover:opacity-100 transition-opacity">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        `;
        grid.appendChild(div);
      };
      reader.readAsDataURL(file);
    });

    // Actualizar el mensaje
    previewContainer.innerHTML = `
      <svg class="w-12 h-12 mx-auto mb-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
      <p class="text-sm text-purple-600 font-medium mb-1">
        ${files.length} imagen${files.length !== 1 ? "es" : ""} seleccionada${files.length !== 1 ? "s" : ""}
      </p>
      <p class="text-xs text-gray-500">Click para cambiar la selecci칩n</p>
    `;
  }

  function eliminarImagenGaleria(index) {
    galeriaFiles.splice(index, 1);

    // Crear un nuevo FileList (simulado con DataTransfer)
    const dataTransfer = new DataTransfer();
    galeriaFiles.forEach((file) => dataTransfer.items.add(file));
    document.getElementById("galeria-input").files = dataTransfer.files;

    // Actualizar preview
    const event = { target: { files: galeriaFiles } };
    previewGaleria(event);
  }

  // Crear producto
  document.getElementById("producto-form").addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const submitBtn = document.getElementById("submit-btn");

      // Agregar todas las im치genes de galer칤a al FormData
      const galeriaInput = document.getElementById("galeria-input");
      if (galeriaInput.files.length > 0) {
        Array.from(galeriaInput.files).forEach((file, index) => {
          formData.append(`galeria_${index}`, file);
        });
      }

      // Deshabilitar bot칩n y mostrar loading
      submitBtn.disabled = true;
      submitBtn.innerHTML = `
      <svg class="animate-spin h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Creando...
    `;

      try {
        const response = await fetch('{% url "productos:admin_producto_crear" %}', {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
            },
            body: formData,
          }
        );

        const data = await response.json();

        if (data.success) {
          showToast(data.message, "success");
          setTimeout(() => {
            window.location.href = data.redirect;
          }, 1000);
        } else {
          showToast(data.message || "Error al crear el producto", "error");
          // Restaurar bot칩n
          submitBtn.disabled = false;
          submitBtn.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          Crear Producto
        `;
        }
      } catch (error) {
        console.error("Error:", error);
        showToast("Error al crear el producto", "error");
        // Restaurar bot칩n
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        Crear Producto
      `;
      }
    });

  // Cargar atributos din치micamente seg칰n la categor칤a
  document.querySelector('select[name="categoria"]').addEventListener("change", function () {
      const categoriaId = this.value;
      const container = document.getElementById("atributos-container");
      const tipoLabel = document.getElementById("tipo-categoria-label");

      if (!categoriaId) {
        container.innerHTML = `
          <div class="text-center py-8">
            <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            <p class="text-gray-500 text-sm">Selecciona una categor칤a para ver los atributos disponibles</p>
          </div>
        `;
        tipoLabel.textContent = "";
        return;
      }

      // Mostrar loading
      container.innerHTML = `
        <div class="text-center py-6">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#1a2332] mx-auto"></div>
          <p class="text-sm text-gray-500 mt-2">Cargando atributos...</p>
        </div>
      `;

      // Obtener atributos por AJAX
      fetch(`/productos/admin-custom/atributos/obtener/?categoria_id=${categoriaId}`)
        .then((response) => response.json())
        .then((data) => {
          if (data.success && data.atributos.length > 0) {
            // Actualizar label del tipo
            const tipoNombres = {
              general: "General",
              electrica: "Veh칤culos El칠ctricos",
              combustion: "Motos de Combusti칩n",
              triciclo: "Triciclos",
            };
            tipoLabel.textContent = `(${tipoNombres[data.tipo_producto] || data.tipo_producto})`;

            let html = "";
            data.atributos.forEach((atributo) => {
              const isGeneral = atributo.tipo_producto.includes("General");
              const colorClass = isGeneral ? "bg-blue-50 border-blue-200" : "bg-purple-50 border-purple-200";
              const labelColor = isGeneral ? "text-blue-600" : "text-purple-600";
              
              html += `
              <div class="p-3 ${colorClass} rounded-lg border">
                <label class="text-sm font-semibold text-gray-700 mb-2 block">
                  ${atributo.nombre}
                  ${atributo.unidad_medida ? `<span class="text-gray-500 font-normal">(${atributo.unidad_medida})</span>` : ""}
                  <span class="text-xs ${labelColor} ml-1 font-normal">${atributo.tipo_producto}</span>
                </label>
                <input
                  type="text"
                  name="atributo_${atributo.id}"
                  placeholder="Ingresa el valor..."
                  class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#1a2332] focus:border-[#1a2332] transition-all bg-white"
                />
              </div>
            `;
            });
            container.innerHTML = html;
          } else {
            container.innerHTML = `
              <div class="text-center py-6">
                <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                </svg>
                <p class="text-gray-500 text-sm">No hay atributos disponibles para esta categor칤a</p>
              </div>
            `;
            tipoLabel.textContent = "";
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          container.innerHTML = `
            <div class="text-center py-6">
              <svg class="w-12 h-12 mx-auto text-red-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <p class="text-red-500 text-sm">Error al cargar atributos</p>
            </div>
          `;
          tipoLabel.textContent = "";
        });
    });
</script>
{% endblock %}
