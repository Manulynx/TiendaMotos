{% extends 'admin_custom/base.html' %} 
{% block title %}Crear Producto{%endblock%} 
{% block page_title %}Crear Nuevo Producto{% endblock %} 
{% block page_subtitle %}Agregar al inventario
{% endblock %} 
{% block content %}

<form
  id="producto-form"
  class="max-w-4xl mx-auto"
  enctype="multipart/form-data"
>
  {% csrf_token %}

  <div class="bg-white rounded-xl shadow-sm p-4 md:p-8 border border-gray-100">
    <div class="space-y-4 md:space-y-6">
      <!-- Nombre -->
      <div>
        <label class="block text-xs md:text-sm font-medium text-gray-700 mb-2">
          Nombre del Producto *
        </label>
        <input
          type="text"
          name="nombre"
          required
          class="w-full px-3 md:px-4 py-2.5 md:py-3 text-sm md:text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-accent focus:border-transparent transition-all"
          placeholder="Ej: Honda CBR 600RR"
        />
      </div>

      <!-- Categor√≠a y Precio -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
        <div>
          <label
            class="block text-xs md:text-sm font-medium text-gray-700 mb-2"
          >
            Categor√≠a *
          </label>
          <select
            name="categoria"
            required
            class="w-full px-3 md:px-4 py-2.5 md:py-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-accent focus:border-transparent transition-all"
          >
            <option value="">Seleccionar...</option>
            {% for cat in categorias %}
            <option value="{{ cat.id }}">{{ cat.nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="grid grid-cols-3 gap-2 md:gap-3">
          <div class="col-span-2">
            <label
              class="block text-xs md:text-sm font-medium text-gray-700 mb-2"
            >
              Precio *
            </label>
            <input
              type="number"
              step="0.01"
              name="precio"
              required
              class="w-full px-3 md:px-4 py-2.5 md:py-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-accent focus:border-transparent transition-all"
              placeholder="0.00"
            />
          </div>

          <div>
            <label
              class="block text-xs md:text-sm font-medium text-gray-700 mb-2"
            >
              Moneda
            </label>
            <select
              name="moneda"
              class="w-full px-2 md:px-4 py-2.5 md:py-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-accent focus:border-transparent transition-all"
            >
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="CUP">CUP</option>
              <option value="MLC">MLC</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Stock -->
      <div>
        <label class="block text-xs md:text-sm font-medium text-gray-700 mb-2">
          Stock Inicial
        </label>
        <input
          type="number"
          name="stock"
          value="0"
          min="0"
          class="w-full px-3 md:px-4 py-2.5 md:py-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-accent focus:border-transparent transition-all"
        />
      </div>

      <!-- Colores Disponibles -->
      <div>
        <label class="block text-xs md:text-sm font-medium text-gray-700 mb-3">
          Colores Disponibles
        </label>
        <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-3">
          {% for color in colores %}
          <label
            class="cursor-pointer group relative"
            title="{{ color.nombre }}"
          >
            <input
              type="checkbox"
              name="colores"
              value="{{ color.id }}"
              class="sr-only peer"
            />
            <div
              class="w-12 h-12 rounded-full border-2 border-gray-300 peer-checked:border-blue-dark peer-checked:ring-2 peer-checked:ring-blue-dark peer-checked:ring-offset-2 transition-all hover:scale-110 relative overflow-hidden"
              style="background-color: {{ color.codigo_hex }};"
            >
              <!-- Checkmark cuando est√° seleccionado -->
              <svg
                class="absolute inset-0 m-auto w-6 h-6 text-white opacity-0 peer-checked:opacity-100 transition-opacity"
                style="filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5))"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="3"
                  d="M5 13l4 4L19 7"
                />
              </svg>
            </div>
            <!-- Tooltip con nombre del color -->
            <span
              class="absolute -bottom-6 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-10"
            >
              {{ color.nombre }}
            </span>
          </label>
          {% endfor %}
        </div>
        <p class="mt-2 text-xs text-gray-500">
          üí° Selecciona todos los colores en los que est√° disponible este
          producto.
        </p>
      </div>

      <!-- Descripci√≥n -->
      <div>
        <label class="block text-xs md:text-sm font-medium text-gray-700 mb-2">
          Descripci√≥n
        </label>
        <textarea
          name="descripcion"
          rows="5"
          class="w-full px-3 md:px-4 py-2.5 md:py-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-accent focus:border-transparent transition-all"
          placeholder="Describe las caracter√≠sticas del producto..."
        ></textarea>
      </div>

      <!-- Atributos Din√°micos -->
      <div>
        <div class="flex items-center justify-between mb-3">
          <label class="block text-xs md:text-sm font-medium text-gray-700">
            Especificaciones T√©cnicas
            <span
              id="tipo-categoria-label"
              class="text-xs text-purple-600 ml-2"
            ></span>
          </label>
          <a
            href="{% url 'productos:admin_atributos_lista' %}"
            target="_blank"
            class="text-xs text-blue-600 hover:text-blue-700 font-medium"
          >
            + Gestionar atributos
          </a>
        </div>

        <div id="atributos-container" class="space-y-3">
          <p class="text-gray-500 text-sm text-center py-6">
            Selecciona una categor√≠a para ver los atributos disponibles
          </p>
        </div>

        <p class="mt-2 text-xs text-gray-500">
          üí° Los atributos se cargan autom√°ticamente seg√∫n la categor√≠a
          seleccionada.
        </p>
      </div>

      <!-- Imagen -->
      <div>
        <label class="block text-xs md:text-sm font-medium text-gray-700 mb-3">
          Imagen Principal
        </label>
        <div
          class="border-2 border-dashed border-gray-300 rounded-xl p-6 md:p-8 text-center hover:border-red-accent transition-colors cursor-pointer"
          onclick="document.getElementById('imagen-input').click()"
        >
          <div id="preview-container">
            <svg
              class="w-12 h-12 md:w-16 md:h-16 mx-auto mb-2 md:mb-3 text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
              />
            </svg>
            <p class="text-sm md:text-base text-gray-600 font-medium mb-1">
              Click para subir imagen
            </p>
            <p class="text-xs md:text-sm text-gray-400">PNG, JPG hasta 5MB</p>
          </div>
        </div>
        <input
          type="file"
          id="imagen-input"
          name="imagen"
          accept="image/*"
          class="hidden"
          onchange="previewImagen(event)"
        />
      </div>
    </div>
  </div>

  <!-- Botones Sticky -->
  <div
    class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-30 md:left-64"
  >
    <div class="max-w-4xl mx-auto px-4 md:px-8 py-3 md:py-4">
      <div class="flex flex-col sm:flex-row gap-2 md:gap-4">
        <button
          type="submit"
          id="submit-btn"
          class="flex-1 px-6 md:px-8 py-2.5 md:py-3 text-sm md:text-base bg-gradient-to-r from-red-accent to-red-600 text-white rounded-xl hover:shadow-xl transition-all font-bold flex items-center justify-center gap-2"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"
            />
          </svg>
          Crear Producto
        </button>

        <a
          href="{% url 'productos:admin_productos_lista' %}"
          class="px-6 md:px-8 py-2.5 md:py-3 text-sm md:text-base bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-all font-medium text-center flex items-center justify-center"
        >
          Cancelar
        </a>
      </div>
    </div>
  </div>

  <!-- Espaciador para compensar botones sticky -->
  <div class="h-20 md:h-24"></div>
</form>

{% endblock %} {% block extra_js %}
<script>
  // Preview de imagen
  function previewImagen(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const container = document.getElementById("preview-container");
        container.innerHTML = `
          <img src="${e.target.result}" class="max-w-full max-h-64 mx-auto rounded-lg shadow-lg">
          <p class="text-sm text-gray-600 mt-3">${file.name}</p>
        `;
      };
      reader.readAsDataURL(file);
    }
  }

  // Crear producto
  document
    .getElementById("producto-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const submitBtn = document.getElementById("submit-btn");

      // Deshabilitar bot√≥n y mostrar loading
      submitBtn.disabled = true;
      submitBtn.innerHTML = `
      <svg class="animate-spin h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Creando...
    `;

      try {
        const response = await fetch(
          '{% url "productos:admin_producto_crear" %}',
          {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
            },
            body: formData,
          }
        );

        const data = await response.json();

        if (data.success) {
          showToast(data.message, "success");
          setTimeout(() => {
            window.location.href = data.redirect;
          }, 1000);
        } else {
          showToast(data.message || "Error al crear el producto", "error");
          // Restaurar bot√≥n
          submitBtn.disabled = false;
          submitBtn.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          Crear Producto
        `;
        }
      } catch (error) {
        console.error("Error:", error);
        showToast("Error al crear el producto", "error");
        // Restaurar bot√≥n
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        Crear Producto
      `;
      }
    });

  // Cargar atributos din√°micamente seg√∫n la categor√≠a
  document
    .querySelector('select[name="categoria"]')
    .addEventListener("change", function () {
      const categoriaId = this.value;
      const container = document.getElementById("atributos-container");
      const tipoLabel = document.getElementById("tipo-categoria-label");

      if (!categoriaId) {
        container.innerHTML =
          '<p class="text-gray-500 text-sm text-center py-6">Selecciona una categor√≠a primero</p>';
        tipoLabel.textContent = "";
        return;
      }

      // Mostrar loading
      container.innerHTML =
        '<div class="text-center py-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-accent mx-auto"></div></div>';

      // Obtener atributos por AJAX
      fetch(
        `/productos/admin-custom/atributos/obtener/?categoria_id=${categoriaId}`
      )
        .then((response) => response.json())
        .then((data) => {
          if (data.success && data.atributos.length > 0) {
            // Actualizar label del tipo
            const tipoNombres = {
              general: "General",
              electrica: "Veh√≠culos El√©ctricos",
              combustion: "Motos de Combusti√≥n",
              triciclo: "Triciclos",
            };
            tipoLabel.textContent = `(${
              tipoNombres[data.tipo_producto] || data.tipo_producto
            })`;

            let html = "";
            data.atributos.forEach((atributo) => {
              const colorClass = atributo.tipo_producto.includes("General")
                ? "bg-blue-50"
                : "bg-purple-50";
              html += `
              <div class="flex items-center gap-3 p-3 ${colorClass} rounded-lg">
                <div class="flex-1">
                  <label class="text-sm font-medium text-gray-700">
                    ${atributo.nombre}
                    ${
                      atributo.unidad_medida
                        ? `<span class="text-gray-500">(${atributo.unidad_medida})</span>`
                        : ""
                    }
                    <span class="text-xs ${
                      atributo.tipo_producto.includes("General")
                        ? "text-blue-600"
                        : "text-purple-600"
                    } ml-1">${atributo.tipo_producto}</span>
                  </label>
                  <input
                    type="text"
                    name="atributo_${atributo.id}"
                    placeholder="Ingresa el valor..."
                    class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-accent focus:border-transparent transition-all"
                  />
                </div>
              </div>
            `;
            });
            container.innerHTML = html;
          } else {
            container.innerHTML =
              '<p class="text-gray-500 text-sm text-center py-4">No hay atributos disponibles para esta categor√≠a</p>';
            tipoLabel.textContent = "";
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          container.innerHTML =
            '<p class="text-red-500 text-sm text-center py-4">Error al cargar atributos</p>';
          tipoLabel.textContent = "";
        });
    });
</script>
{% endblock %}
